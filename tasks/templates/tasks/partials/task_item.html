{% load markdown_extras %}
<div class="task-item {% if task.is_completed %}completed{% endif %}"
     id="task-{{ task.id }}"
     data-task-id="{{ task.id }}"
     data-parent-id="{{ task.parent_id|default:'' }}"
     data-section-id="{{ task.section_id }}"
     style="padding-left: {{ depth|default:0|add:0 }}em;">
  <div class="task-row">
    {% if task.is_completed %}
    <button class="checkbox checked"
            hx-post="/tasks/{{ task.id }}/uncomplete/"
            hx-swap="none">&#9745;</button>
    {% else %}
    <button class="checkbox"
            hx-post="/tasks/{{ task.id }}/complete/"
            hx-swap="none">&#9744;</button>
    {% endif %}

    <span class="task-title">{{ task.title|linkify }}</span>

    {% if not task.is_completed %}
    <button class="pin-btn {% if task.is_pinned %}pinned{% endif %}"
            hx-post="/tasks/{{ task.id }}/pin/"
            hx-swap="none"
            data-pin-task-id="{{ task.id }}"
            title="{% if task.is_pinned %}Unpin{% else %}Pin to top{% endif %}"
            onclick="event.stopPropagation();">
      <svg class="pin-icon" width="14" height="14" viewBox="0 0 24 24" fill="{% if task.is_pinned %}currentColor{% else %}none{% endif %}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17v5"/><path d="M9 2h6l-1.5 5H15a3 3 0 0 1 3 3v2H6v-2a3 3 0 0 1 3-3h.5L8 2z"/></svg>
    </button>
    {% endif %}

    {% if task.due_date %}
    <span class="task-due-date{% if not task.is_completed %} due-{{ task.due_date|due_date_status }}{% endif %}">{{ task.due_date|date:"M j" }}</span>
    {% endif %}

    {% for tag in task.tags.all %}
    <span class="task-tag">{{ tag.name }}</span>
    {% endfor %}
  </div>
  {% if show_parent_context and task.parent %}
  <div class="task-parent-context">
    <button type="button"
            class="parent-task-link"
            data-parent-task-id="{{ task.parent_id }}"
            onclick="event.stopPropagation(); jumpToTask({{ task.parent_id }});">
      Parent: {{ task.parent.title }}
    </button>
  </div>
  {% endif %}

  {% with subtask_list=task.subtasks.all %}
  <details open class="subtask-collapsible">
    <summary class="subtask-collapse-toggle" onclick="event.stopPropagation();">
      <span class="subtask-collapse-icon"></span>
      <span class="subtask-collapse-count">{% if subtask_list %}{{ subtask_list|length }} subtask{{ subtask_list|length|pluralize }} &mdash; {{ task.open_subtask_count }} open{% endif %}</span>
    </summary>
    <div class="subtask-collapsible-content">
      <div class="subtask-drop-zone sortable-tasks" data-section-id="{{ task.section_id }}" data-parent-task-id="{{ task.id }}">
        {% for subtask in subtask_list %}
          {% if not subtask.is_completed %}
            {% include "tasks/partials/task_item.html" with task=subtask depth=depth|default:0|add:1 %}
          {% endif %}
        {% endfor %}
      </div>
      <details class="subtask-completed-group">
        <summary class="subtask-completed-toggle">
          <span class="completed-toggle-icon"></span>
          Done
        </summary>
        <div class="subtask-completed-items">
          {% for subtask in subtask_list %}
            {% if subtask.is_completed %}
              {% include "tasks/partials/task_item.html" with task=subtask depth=depth|default:0|add:1 %}
            {% endif %}
          {% endfor %}
        </div>
      </details>
    </div>
  </details>
  {% endwith %}
</div>
